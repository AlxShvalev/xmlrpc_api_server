# XML-RPC Server

## Описание
Тестовое задание на позицию Программист Python.

Сервис реализует XML-RPC сервер для выборки данных из БД.
При этом для верификации пользователя сервис использует метод 
Challenge-response authentication.
В качестве подписи челленджа используется метод разделяемых ключей 
Диффи-Хеллмана (Diffie-Hellman key exchange protokol)

Сервер реализует следующие методы:
- авторизация пользователя по username и password;
- метод для выработки секрета по алгоритму Диффи-Хеллмана;
- метод запроса челленджа;
- метод получения данных из БД с подписью запроса секретом.
---
## Установка
- Клонировать репозиторий
```bash
git clone https://github.com/AlxShvalev/xmlrpc_crypt.git
```
или
```bash
git clone git@github.com:AlxShvalev/xmlrpc_crypt.git
```
- перейти в папку с проектом, активировать виртуальное окружение 
и установить зависимости:
```bash
python3 -m venv venv
pip install --upgrade pip
pip install -r requirements.txt
```
- в файле settings.py указать нужные параметры сервера (IP-адрес, порт), 
а так же параметры подключения к БД PostgreSQL
- запустить проект
```bash
python main.py
```
---
## Описание клиента
Для работы с сервером используется следующий клиент:

```python
from xmlrpc.client import ServerProxy

url = f"http://{settings.RPC_SERVER_HOST}:{settings.RPC_SERVER_PORT}/RPC2"

client = ServerProxy(url)
```
---
## Описание методов сервера

### Метод аутентификации. 
Входные параметры:
- username (String)
- password (String).

Выходные параметры:
- session_id (String)

Если пользователь найден в БД, метод создает для него сессию и 
возвращает идентификатор сессии (String).
```python
client.auth("username", "password") 
# "867db577-33d6-49d3-8919-706873214d89"
```

### Метод выработки секрета по алгоритму Диффи-Хеллмана. 
Выработка секрета происходит в два этапа. 

На первом этапе клиент отправляет запрос на сервер и получает словарь
с публичными ключами

```python
client.get_pub_keys()

# {
#     "pub_key1": 2,
#     "pub_key2": 3,
# }
```
На втором этапе клиент вычисляет свою часть частичного ключа
по алгоритму Диффи-Хеллмана и отправляет его серверу. Сервер в ответ возвращает 
свой частичный ключ. 

```python
client.partial_keys_exchange(session_id, client_part_key)
```
После этого и сервер и клиент могут вычислить общий секретный ключ по алгоритму
Диффи-Хеллмана.

### Метод запроса челленджа
Клиент выполняет запрос, сервер возвращает случайно сгенерированную строку 
```python
challenge = client.get_challenge(session_id)

# aSddwqertDFSfqf
```

### Метод запроса данных из БД
Клиент подписывает полученный от сервера челлендж, используя в качестве ключа 
вычисленный общий с сервером секретный ключ.

```python
import hashlib, hmac

signature = hmac.new(bytes(secret_key), challenge.dh_server(), hashlib.sha256) 
```
После этого клиент отправляет на сервер запрос, содержащий id сессии, ключ 
для выборки данных и подписанный челлендж.
```python
client.get_data(session_id, data_key, challenge.hexdigest())
```
Сервер проверяет подпись челленджа. В случае успеха сервер делает выборку
из БД по предоставленному ключу и возвращает данные.

Примеры запросов к серверу находятся в файле `client.py`

### Автор
Алексей Швалев